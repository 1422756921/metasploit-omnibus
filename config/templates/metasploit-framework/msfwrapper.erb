#!/bin/sh
cmd=`basename $0`

if [ $cmd = "msfrunner" ]; then
  echo "This script wraps metasploit framework commands to run in the correct environment."
  echo " Do not run it directly."
  exit 1
fi

CWD=`pwd`
cd `dirname $0`
SCRIPTDIR=`pwd -P`
EMBEDDED=$SCRIPTDIR/../embedded
BIN=$EMBEDDED/bin
FRAMEWORK=$SCRIPTDIR/../framework

LOCALCONF=~/.msf4
DB=$LOCALCONF/db
DBCONF=$LOCALCONF/database.yml
cd $CWD

start_db() {
  if [ -e $DB -a -e $DBCONF ]; then
    $BIN/pg_ctl -D $DB status > /dev/null
    if [ $? != 0 ]; then
      echo Starting Postgresql
      $BIN/pg_ctl -D $DB -l $DB/log start > /dev/null
      sleep 2
    fi
  fi
}

start_db
(
 cd $FRAMEWORK
 PATH=$BIN:$EMBEDDED/john:$SCRIPTDIR
 $BIN/bundle exec $BIN/ruby ./$cmd
)
