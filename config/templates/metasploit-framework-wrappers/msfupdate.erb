#!/bin/sh

print_pgp_key() {
  cat <<-EOF
-----BEGIN PGP PUBLIC KEY BLOCK-----

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
LvsZoz197/1VjPgy
=t7Y1
-----END PGP PUBLIC KEY BLOCK-----
EOF
}

install_deb() {
  LIST_FILE=/etc/apt/sources.list.d/metasploit-framework.list
  PREF_FILE=/etc/apt/preferences.d/pin-metasploit.pref
  if [ ! -f $LIST_FILE ]; then
    echo -n "Adding metasploit-framework to your repository list.."
    echo "deb $DOWNLOAD_URI/apt lucid main" > $LIST_FILE
    print_pgp_key | apt-key add -
  fi
  if [ ! -f $PREF_FILE ]; then
    mkdir -p /etc/apt/preferences.d/
    cat > $PREF_FILE <<EOF
Package: metasploit*
Pin: origin downloads.metasploit.com
Pin-Priority: 1000
EOF
  fi
  echo -n "Updating package cache.."
  apt-get update > /dev/null
  echo "OK"
  echo "Checking for and installing update.."
  apt-get install -y --allow-downgrades metasploit-framework
}

install_rpm() {
  echo "Checking for and installing update.."
  REPO_FILE=/etc/yum.repos.d/metasploit-framework.repo
  GPG_KEY_FILE=/etc/pki/rpm-gpg/RPM-GPG-KEY-Metasploit
  if [ ! -f $REPO_FILE ]; then
    echo -n "Adding metasploit-framework to your repository list.."

    cat > /etc/yum.repos.d/metasploit-framework.repo <<EOF
[metasploit]
name=Metasploit
baseurl=$DOWNLOAD_URI/rpm
gpgcheck=1
gpgkey=file://$GPG_KEY_FILE
enabled=1
EOF
    print_pgp_key > ${GPG_KEY_FILE}
  fi
  yum install -y metasploit-framework
}

install_pkg()
{
  (
    cd ~/Downloads

    echo "Downloading package..."
    curl -O "$DOWNLOAD_URI/osx/metasploitframework-latest.pkg"

    echo "Checking signature..."

    if pkgutil --check-signature metasploitframework-latest.pkg; then
      echo "Installing package..."
      installer -pkg metasploitframework-latest.pkg -target /
    fi

    echo "Cleaning up..."
    rm -fv metasploitframework-latest.pkg
  )
}

DOWNLOAD_URI=http://downloads.metasploit.com/data/releases/metasploit-framework
PKGTYPE=unknown
ID=`id -u`

if [ -f /etc/redhat-release ] ; then
  PKGTYPE=rpm
elif [ -f /etc/system-release ] ; then
  # If /etc/system-release is present, this is likely a distro that uses RPM.
  PKGTYPE=rpm
else
  if uname -sv | grep 'Darwin' > /dev/null; then
    PKGTYPE=pkg
  else
    PKGTYPE=deb
  fi
fi

if [ "$ID" -ne 0 ]; then
  if ! hash sudo 2>/dev/null; then
    echo "This script must be executed as the 'root' user or with sudo"
    exit 1
  else
    echo "Switching to root user to update the package"
    sudo -E $0 $@
    exit 0
  fi
fi

case $PKGTYPE in
  deb)
    install_deb
    ;;
  rpm)
    install_rpm
    ;;
  *)
    install_pkg
esac
